"""Python classes associated with LimeSurvey objects (surveys, questions, etc.)."""
\nfrom __future__ import annotations\n\nimport xml.etree.ElementTree as ET\nfrom dataclasses import dataclass, field\nfrom typing import TYPE_CHECKING, Any, List, Optional\n\nif TYPE_CHECKING:\n    from uuid import UUID\n\n    from citric.types import YesNo\n\n\ndef to_yes_no(*, value: bool) -> YesNo:\n    """Convert boolean to yes/no string."""  # noqa: DOC201\n    return "Y" if value else "N"\n\n\ndef _add_element_with_text(parent: ET.Element, tag: str, text: Any, cdata: bool = False):\n    """Add a subelement with text content, optionally wrapped in CDATA."""\n    subelement = ET.SubElement(parent, tag)\n    if text is not None:\n        if cdata:\n            # We'll use a placeholder for CDATA and replace it later\n            subelement.text = f"__CDATA_START__{text}__CDATA_END__"\n        else:\n            subelement.text = str(text)\n    return subelement\n\n\ndef _add_simple_element(parent: ET.Element, tag: str, text: Any):\n    """Add a subelement with simple text content (no CDATA)."""\n    return _add_element_with_text(parent, tag, text, cdata=False)\n\ndef _add_cdata_element(parent: ET.Element, tag: str, text: Any):\n    """Add a subelement with text content wrapped in CDATA."""\n    return _add_element_with_text(parent, tag, text, cdata=True)\n\n\n@dataclass\nclass Participant:\n    """Participant data."""\n\n    firstname: str\n    lastname: str\n    email: str\n    participant_id: Optional[UUID] = None\n    language: Optional[str] = "en"\n    blacklisted: bool = False\n    attributes: dict[str, Any] = field(default_factory=dict)\n\n    def to_dict(self) -> dict[str, Any]:\n        """Convert to dictionary."""\n        return {\n            "participant_id": str(self.participant_id) if self.participant_id else None,\n            "firstname": self.firstname,\n            "lastname": self.lastname,\n            "email": self.email,\n            "language": self.language,\n            "blacklisted": to_yes_no(value=self.blacklisted),\n            **self.attributes,\n        }\n\n\n@dataclass\nclass Question:\n    """Question data."""\n\n    qid: Optional[int] = None\n    sid: Optional[int] = None\n    gid: Optional[int] = None\n    type: str = "T"\n    title: str = ""\n    question: str = ""\n    question_order: Optional[int] = None\n    mandatory: str = "N"\n    other: str = "N"\n    # ... more fields as needed\n\n    def to_xml(self, parent: ET.Element, language: str = "en"):\n        """Generate XML for the question."""\n        question_row = ET.SubElement(parent, "row")\n        _add_cdata_element(question_row, "qid", self.qid)\n        _add_cdata_element(question_row, "sid", self.sid)\n        _add_cdata_element(question_row, "gid", self.gid)\n        _add_cdata_element(question_row, "type", self.type)\n        _add_cdata_element(question_row, "title", self.title)\n        _add_cdata_element(question_row, "question_order", self.question_order)\n        _add_cdata_element(question_row, "mandatory", self.mandatory)\n        _add_cdata_element(question_row, "other", self.other)\n        # Add more fields as identified from .lsq and .lss files\n\n\n@dataclass\nclass QuestionGroup:\n    """Question group data."""\n\n    gid: Optional[int] = None\n    sid: Optional[int] = None\n    group_name: str = ""\n    description: str = ""\n    group_order: Optional[int] = None\n    questions: List[Question] = field(default_factory=list)\n    # ... more fields as needed\n\n    def to_xml(self, groups_rows_element: ET.Element, group_l10ns_rows_element: ET.Element, language: str = "en"):\n        """Generate XML for the question group."""\n        group_row = ET.SubElement(groups_rows_element, "row")\n        _add_cdata_element(group_row, "gid", self.gid)\n        _add_cdata_element(group_row, "sid", self.sid)\n        _add_cdata_element(group_row, "group_order", self.group_order)\n        _add_cdata_element(group_row, "randomization_group", None) # Default\n        _add_cdata_element(group_row, "grelevance", "1") # Default\n\n\n        group_l10n_row = ET.SubElement(group_l10ns_rows_element, "row")\n        _add_cdata_element(group_l10n_row, "id", self.gid) # Using gid as id for now\n        _add_cdata_element(group_l10n_row, "gid", self.gid)\n        _add_cdata_element(group_l10n_row, "group_name", self.group_name)\n        _add_cdata_element(group_l10n_row, "description", self.description)\n        _add_simple_element(group_l10n_row, "language", language)\n        _add_cdata_element(group_l10n_row, "sid", self.sid)\n        _add_cdata_element(group_l10n_row, "group_order", self.group_order)\n        _add_cdata_element(group_l10n_row, "randomization_group", None) # Default\n        _add_cdata_element(group_l10n_row, "grelevance", "1") # Default\n\n\n@dataclass\nclass Survey:\n    """Survey data."""\n\n    sid: Optional[int] = None\n    admin: str = ""\n    adminemail: str = ""\n    surveyls_title: str = ""\n    languages: List[str] = field(default_factory=lambda: ["en"])\n    question_groups: List[QuestionGroup] = field(default_factory=list)\n    # ... more fields as needed\n\n    def to_xml(self) -> str:\n        """Generate XML for the survey."""\n        root = ET.Element("document")\n        _add_simple_element(root, "LimeSurveyDocType", "Survey")\n        _add_simple_element(root, "DBVersion", "627")  # Use a recent version\n\n        languages_element = ET.SubElement(root, "languages")\n        for lang in self.languages:\n            _add_simple_element(languages_element, "language", lang)\n\n        # Surveys section\n        surveys_element = ET.SubElement(root, "surveys")\n        surveys_fields = ET.SubElement(surveys_element, "fields")\n        for fieldname in [\n            "sid", "gsid", "admin", "expires", "startdate", "adminemail", "anonymized", "faxto",\n            "format", "savetimings", "template", "language", "additional_languages", "datestamp",\n            "usecookie", "allowregister", "allowsave", "autonumber_start", "autoredirect",\n            "allowprev", "printanswers", "ipaddr", "refurl", "showsurveypolicynotice",\n            "publicstatistics", "showdatapolicybutton", "showlegalnoticebutton",\n            "publicgraphs", "listpublic", "htmlemail", "sendconfirmation",\n            "tokenanswerspersistence", "assessments", "usecaptcha", "usetokens",\n            "bounce_email", "attributedescriptions", "emailresponseto",\n            "emailnotificationto", "tokenlength", "showxquestions", "showgroupinfo",\n            "shownoanswer", "showqnumcode", "bouncetime", "bounceprocessing",\n            "bounceaccounttype", "bounceaccounthost", "bounceaccountpass",\n            "bounceaccountencryption", "bounceaccountuser", "showwelcome",\n            "showprogress", "questionindex", "navigationdelay", "nokeyboard",\n            "alloweditaftercompletion", "googleanalyticsstyle", "googleanalyticsapikey",\n            "tokenencryptionoptions", "ipanonymize"\n        ]:\n            _add_cdata_element(surveys_fields, "fieldname", fieldname)\n        surveys_rows = ET.SubElement(surveys_element, "rows")\n        survey_row = ET.SubElement(surveys_rows, "row")\n        _add_cdata_element(survey_row, "sid", self.sid)\n        _add_cdata_element(survey_row, "admin", self.admin)\n        _add_cdata_element(survey_row, "adminemail", self.adminemail)\n        _add_cdata_element(survey_row, "language", self.languages[0] if self.languages else None)\n        _add_cdata_element(survey_row, "gsid", "1") # Default\n        _add_cdata_element(survey_row, "anonymized", "N") # Default\n        _add_cdata_element(survey_row, "format", "A") # Default\n        _add_cdata_element(survey_row, "savetimings", "N") # Default\n        _add_cdata_element(survey_row, "template", "default") # Default\n        _add_cdata_element(survey_row, "datestamp", "N") # Default\n        _add_cdata_element(survey_row, "usecookie", "N") # Default\n        _add_cdata_element(survey_row, "allowregister", "N") # Default\n        _add_cdata_element(survey_row, "allowsave", "N") # Default\n        _add_cdata_element(survey_row, "autonumber_start", "0") # Default\n        _add_cdata_element(survey_row, "autoredirect", "N") # Default\n        _add_cdata_element(survey_row, "allowprev", "N") # Default\n        _add_cdata_element(survey_row, "printanswers", "N") # Default\n        _add_cdata_element(survey_row, "ipaddr", "N") # Default\n        _add_cdata_element(survey_row, "refurl", "N") # Default\n        _add_cdata_element(survey_row, "showsurveypolicynotice", "0") # Default\n        _add_cdata_element(survey_row, "publicstatistics", "N") # Default\n        _add_cdata_element(survey_row, "showdatapolicybutton", "0") # Default\n        _add_cdata_element(survey_row, "showlegalnoticebutton", "0") # Default\n        _add_cdata_element(survey_row, "publicgraphs", "N") # Default\n        _add_cdata_element(survey_row, "listpublic", "N") # Default\n        _add_cdata_element(survey_row, "htmlemail", "N") # Default\n        _add_cdata_element(survey_row, "sendconfirmation", "N") # Default\n        _add_cdata_element(survey_row, "tokenanswerspersistence", "N") # Default\n        _add_cdata_element(survey_row, "assessments", "N") # Default\n        _add_cdata_element(survey_row, "usecaptcha", "N") # Default\n        _add_cdata_element(survey_row, "usetokens", "N") # Default\n        _add_cdata_element(survey_row, "tokenlength", "15") # Default\n        _add_cdata_element(survey_row, "showxquestions", "N") # Default\n        _add_cdata_element(survey_row, "showgroupinfo", "N") # Default\n        _add_cdata_element(survey_row, "shownoanswer", "N") # Default\n        _add_cdata_element(survey_row, "showqnumcode", "N") # Default\n        _add_cdata_element(survey_row, "bounceprocessing", "N") # Default\n        _add_cdata_element(survey_row, "showwelcome", "N") # Default\n        _add_cdata_element(survey_row, "showprogress", "N") # Default\n        _add_cdata_element(survey_row, "questionindex", "0") # Default\n        _add_cdata_element(survey_row, "navigationdelay", "0") # Default\n        _add_cdata_element(survey_row, "nokeyboard", "N") # Default\n        _add_cdata_element(survey_row, "alloweditaftercompletion", "N") # Default\n        _add_cdata_element(survey_row, "ipanonymize", "N") # Default\n\n\n        # Surveys language settings\n        surveys_l10n_element = ET.SubElement(root, "surveys_languagesettings")\n        surveys_l10n_fields = ET.SubElement(surveys_l10n_element, "fields")\n        for fieldname in [\n            "surveyls_survey_id", "surveyls_policy_error", "surveyls_legal_notice",\n            "surveyls_email_invite_subj", "surveyls_email_invite",\n            "surveyls_email_remind_subj", "surveyls_email_remind",\n            "surveyls_email_register_subj", "surveyls_email_register",\n            "surveyls_email_confirm_subj", "surveyls_email_confirm",\n            "surveyls_dateformat", "surveyls_attributecaptions",\n            "email_admin_notification_subj", "email_admin_notification",\n            "email_admin_responses_subj", "email_admin_responses",\n            "surveyls_numberformat", "attachments", "surveyls_alias",\n            "surveyls_language", "surveyls_title", "surveyls_description",\n            "surveyls_welcometext", "surveyls_endtext", "surveyls_policy_notice",\n            "surveyls_policy_notice_label", "surveyls_url", "surveyls_urldescription"\n        ]:\n            _add_cdata_element(surveys_l10n_fields, "fieldname", fieldname)\n        surveys_l10n_rows = ET.SubElement(surveys_l10n_element, "rows")\n        survey_l10n_row = ET.SubElement(surveys_l10n_rows, "row")\n        _add_cdata_element(survey_l10n_row, "surveyls_survey_id", self.sid)\n        _add_simple_element(survey_l10n_row, "surveyls_language", self.languages[0] if self.languages else None)\n        _add_cdata_element(survey_l10n_row, "surveyls_title", self.surveyls_title)\n        # Defaults for other fields\n        _add_cdata_element(survey_l10n_row, "surveyls_dateformat", "1")\n        _add_cdata_element(survey_l10n_row, "surveyls_numberformat", "0")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_invite_subj", "Invitation to participate in a survey")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_invite", "Dear {FIRSTNAME},\n\nYou have been invited to participate in a survey.\n\nThe survey is titled:\n\"{SURVEYNAME}\"\n\n\"{SURVEYDESCRIPTION}\"\n\nTo participate, please click on the link below.\n\nSincerely,\n\n{ADMINNAME} ({ADMINEMAIL})\n\n----------------------------------------------\nClick here to do the survey:\n{SURVEYURL}\n\nIf you do not want to participate in this survey and don't want to receive any more invitations please click the following link:\n{OPTOUTURL}")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_remind_subj", "Reminder to participate in a survey")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_remind", "Dear {FIRSTNAME},\n\nRecently we invited you to participate in a survey.\n\nWe note that you have not yet completed the survey, and wish to remind you that the survey is still available should you wish to take part.\n\nThe survey is titled:\n\"{SURVEYNAME}\"\n\n\"{SURVEYDESCRIPTION}\"\n\nTo participate, please click on the link below.\n\nSincerely,\n\n{ADMINNAME} ({ADMINEMAIL})\n\n----------------------------------------------\nClick here to do the survey:\n{SURVEYURL}\n\nIf you do not want to participate in this survey and don't want to receive any more invitations please click the following link:\n{OPTOUTURL}")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_register_subj", "Survey registration confirmation")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_register", "Dear {FIRSTNAME},\n\nYou, or someone using your email address, have registered to participate in an online survey titled {SURVEYNAME}.\n\nTo complete this survey, click on the following URL:\n\n{SURVEYURL}\n\nIf you have any questions about this survey, or if you did not register to participate and believe this email is in error, please contact {ADMINNAME} at {ADMINEMAIL}.")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_confirm_subj", "Confirmation of your participation in our survey")\n        _add_cdata_element(survey_l10n_row, "surveyls_email_confirm", "Dear {FIRSTNAME},\n\nThis email is to confirm that you have completed the survey titled {SURVEYNAME} and your response has been saved. Thank you for participating.\n\nIf you have any further questions about this email, please contact {ADMINNAME} on {ADMINEMAIL}.\n\nSincerely,\n\n{ADMINNAME}")\n        _add_cdata_element(survey_l10n_row, "email_admin_notification_subj", "Response submission for survey {SURVEYNAME}")\n        _add_cdata_element(survey_l10n_row, "email_admin_notification", "Hello,\n\nA new response was submitted for your survey \'{SURVEYNAME}\'.\n\nClick the following link to see the individual response:\n{VIEWRESPONSEURL}\n\nClick the following link to edit the individual response:\n{EDITRESPONSEURL}\n\nView statistics by clicking here:\n{STATISTICSURL}")\n        _add_cdata_element(survey_l10n_row, "email_admin_responses_subj", "Response submission for survey {SURVEYNAME} with results")\n        _add_cdata_element(survey_l10n_row, "email_admin_responses", "Hello,\n\nA new response was submitted for your survey \'{SURVEYNAME}\'.\n\nClick the following link to see the individual response:\n{VIEWRESPONSEURL}\n\nClick the following link to edit the individual response:\n{EDITRESPONSEURL}\n\nView statistics by clicking here:\n{STATISTICSURL}\n\n\nThe following answers were given by the participant:\n{ANSWERTABLE}")\n\n\n        # Question Groups\n        groups_element = ET.SubElement(root, "groups")\n        groups_fields = ET.SubElement(groups_element, "fields")\n        for fieldname in ["gid", "sid", "group_order", "randomization_group", "grelevance"]:\n            _add_cdata_element(groups_fields, "fieldname", fieldname)\n        groups_rows = ET.SubElement(groups_element, "rows")\n\n        group_l10ns_element = ET.SubElement(root, "group_l10ns")\n        group_l10ns_fields = ET.SubElement(group_l10ns_element, "fields")\n        for fieldname in [\n            "id", "gid", "group_name", "description", "language", "sid",\n            "group_order", "randomization_group", "grelevance"\n        ]:\n            _add_cdata_element(group_l10ns_fields, "fieldname", fieldname)\n        group_l10ns_rows = ET.SubElement(group_l10ns_element, "rows")\n\n        questions_element = ET.SubElement(root, "questions")\n        questions_fields = ET.SubElement(questions_element, "fields")\n        for fieldname in [\n            "qid", "parent_qid", "sid", "gid", "type", "title", "preg", "other",\n            "mandatory", "question_order", "scale_id", "same_default", "relevance",\n            "modulename", "encrypted", "question_theme_name", "same_script"\n        ]:\n            _add_cdata_element(questions_fields, "fieldname", fieldname)\n        questions_rows = ET.SubElement(questions_element, "rows")\n\n        question_l10ns_element = ET.SubElement(root, "question_l10ns")\n        question_l10ns_fields = ET.SubElement(question_l10ns_element, "fields")\n        for fieldname in ["id", "qid", "question", "help", "language", "script"]:\n            _add_cdata_element(question_l10ns_fields, "fieldname", fieldname)\n        question_l10ns_rows = ET.SubElement(question_l10ns_element, "rows")\n\n\n        # Add question groups and questions\n        for i, group in enumerate(self.question_groups):\n            group.gid = group.gid or (i + 1) # Assign a GID if not set\n            group.sid = self.sid\n            group.group_order = group.group_order or (i + 1)\n            group.to_xml(groups_rows, group_l10ns_rows, self.languages[0] if self.languages else None)\n\n            for j, question in enumerate(group.questions):\n                question.qid = question.qid or (j + 1)\n                question.sid = self.sid\n                question.gid = group.gid\n                question.question_order = question.question_order or (j + 1)\n                question.to_xml(questions_rows, self.languages[0] if self.languages else None)\n                # For question_l10ns, need to create a separate row\n                question_l10n_row = ET.SubElement(question_l10ns_rows, "row")\n                _add_cdata_element(question_l10n_row, "id", question.qid) # Using qid as id for now\n                _add_cdata_element(question_l10n_row, "qid", question.qid)\n                _add_cdata_element(question_l10n_row, "question", question.question)\n                _add_simple_element(question_l10n_row, "language", self.languages[0] if self.languages else None)\n\n\n        # Convert to string\n        xml_string = ET.tostring(root, encoding="UTF-8", xml_declaration=True).decode("utf-8")\n        xml_string = xml_string.replace("__CDATA_START__", "<[CDATA[")\n        xml_string = xml_string.replace("__CDATA_END__", "]]>")\n        return xml_string\n
