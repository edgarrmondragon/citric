name: API Changes ðŸ¤

on:
  pull_request:
    paths:
    - requirements/requirements*.txt
    - src/**
    - .github/workflows/api-changes.yml
    - CHANGELOG.md

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

env:
  FORCE_COLOR: 1
  # renovate: datasource=pypi depName=griffe
  GRIFFE_VERSION: 2.0.0
  # renovate: datasource=pypi depName=nox
  NOX_VERSION: 2025.11.12
  # renovate: datasource=pypi depName=uv
  UV_VERSION: 0.10.0

permissions:  # added using https://github.com/step-security/secure-repo
  contents: read

jobs:
  check-api-changes:
    name: Check API Changes
    runs-on: ubuntu-24.04
    env:
      NOXSESSION: api
    steps:
    - name: Check out the repository
      uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      with:
        fetch-depth: 0
        persist-credentials: false

    - name: Setup Python
      uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
      with:
        python-version: 3.x

    - name: Install uv
      uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
      with:
        version: ${{ env.UV_VERSION }}

    - name: Install tools
      run: |
        uv tool install --with nox==${NOX_VERSION} nox
        uv tool install --with griffe==${GRIFFE_VERSION} griffe
        uv tool list
      env:
        NOX_VERSION: ${{ env.NOX_VERSION }}
        GRIFFE_VERSION: ${{ env.GRIFFE_VERSION }}

    - name: Set REF
      id: set-ref
      if: always() && !startsWith(github.head_ref, 'release/')
      env:
        BASE_SHA: ${{ github.event.pull_request.base.sha }}
      run: |
        echo "ref=$BASE_SHA" >> $GITHUB_OUTPUT

    # Check API against the latest commit on the base branch
    - name: Run Nox
      env:
        REF: ${{ steps.set-ref.outputs.ref }}
      run: |
        nox -- ${REF}
